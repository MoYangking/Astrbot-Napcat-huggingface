<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nginx 动态路由管理</title>
  <style>
    :root { --bg:#0b1020; --card:#121933; --fg:#e7ecff; --muted:#a7b0d6; --accent:#6aa3ff; --ok:#2ecc71; --err:#ff4757; }
    html,body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans SC, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 16px 0 8px; color: var(--muted); }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    input[type=text], input[type=password] { flex: 1 1 240px; padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3359; background: #0e1430; color: var(--fg); outline: none; }
    input[type=text]:focus, input[type=password]:focus { border-color: var(--accent); }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: var(--accent); color: #fff; cursor: pointer; }
    button.secondary { background: #33406e; }
    button.danger { background: var(--err); }
    .muted { color: var(--muted); font-size: 12px; }
    .status { margin-left: 8px; font-size: 12px; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    textarea { width: 100%; min-height: 260px; padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3359; background: #0e1430; color: var(--fg); outline: none; resize: vertical; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Nginx 动态路由管理</h1>
      <div class="row">
        <input id="token" type="password" placeholder="管理员密码（默认：admin）" />
        <button id="saveToken">保存密码</button>
        <span id="tokenStatus" class="status"></span>
      </div>
      <div class="footer">说明：本界面通过 <code>/admin/routes.json</code> 与 <code>/admin/password</code> 接口管理配置，所有请求均需携带管理员密码。</div>
    </div>

    <div class="card">
      <h2>默认后端</h2>
      <div class="row">
        <input id="defaultBackend" type="text" placeholder="例如：http://127.0.0.1:6185" />
        <button id="setDefault">更新默认后端</button>
        <span id="defaultStatus" class="status"></span>
      </div>
    </div>

    <div class="card">
      <h2>高级规则（JSON 配置）</h2>
      <div class="muted">支持按 Host、Path 前缀、Referer（子串/正则）、HTTP 方法、Header 条件进行匹配，并通过优先级控制先后顺序。保存后即时生效。</div>
      <div class="row" style="margin: 8px 0; gap: 8px;">
        <button id="loadJson" class="secondary">加载 JSON</button>
        <button id="toggleMode" class="secondary">切换到可视化编辑</button>
        <span id="jsonStatus" class="status"></span>
      </div>

      <div id="jsonEditorBox">
        <div class="row" style="margin: 8px 0; gap: 8px;">
          <button id="saveJson">保存 JSON</button>
        </div>
        <textarea id="rulesJson" placeholder='示例：
{
  "default_backend": "http://127.0.0.1:6185",
  "rules": [
    {
      "id": "service-a",
      "action": "proxy",
      "priority": 100,
      "backend": "http://127.0.0.1:7001",
      "match": {"host": "example.com", "path_prefix": "/api/a"}
    },
    {
      "id": "service-b",
      "action": "redirect",
      "priority": 90,
      "match": {"path_prefix": "/legacy/"},
      "redirect_to_prefix": "/new/"
    }
  ]
}
'></textarea>
      </div>

      <div id="visualEditorBox" style="display:none;">
        <div class="row" style="margin: 8px 0; gap: 8px;">
          <input id="veDefault" type="text" placeholder="默认后端（如：http://127.0.0.1:6185）" />
          <button id="veAddRule">添加规则</button>
          <button id="veSave">保存（可视化）</button>
        </div>
        <div id="veRules"></div>
      </div>
    </div>

    <div class="card">
      <h2>修改管理员密码</h2>
      <div class="row" style="gap:8px;">
        <input id="oldPass" type="password" placeholder="当前密码" />
        <input id="newPass" type="password" placeholder="新密码" />
        <input id="newPass2" type="password" placeholder="确认新密码" />
        <button id="btnChgPwd">修改密码</button>
        <span id="chgPwdStatus" class="status"></span>
      </div>
    </div>

    <div class="muted">© 动态路由面板</div>
  </div>

  <script>
    const els = {
      token: document.getElementById('token'),
      saveToken: document.getElementById('saveToken'),
      tokenStatus: document.getElementById('tokenStatus'),
      defaultBackend: document.getElementById('defaultBackend'),
      setDefault: document.getElementById('setDefault'),
      defaultStatus: document.getElementById('defaultStatus'),
      rulesJson: document.getElementById('rulesJson'),
      loadJson: document.getElementById('loadJson'),
      saveJson: document.getElementById('saveJson'),
      jsonStatus: document.getElementById('jsonStatus'),
      toggleMode: document.getElementById('toggleMode'),
      jsonEditorBox: document.getElementById('jsonEditorBox'),
      visualEditorBox: document.getElementById('visualEditorBox'),
      veDefault: document.getElementById('veDefault'),
      veRules: document.getElementById('veRules'),
      veAddRule: document.getElementById('veAddRule'),
      veSave: document.getElementById('veSave'),
      oldPass: document.getElementById('oldPass'),
      newPass: document.getElementById('newPass'),
      newPass2: document.getElementById('newPass2'),
      btnChgPwd: document.getElementById('btnChgPwd'),
      chgPwdStatus: document.getElementById('chgPwdStatus'),
    };

    function getToken() {
      return localStorage.getItem('routeAdminPassword') || '';
    }

    function setToken(t) {
      if (t) localStorage.setItem('routeAdminPassword', t); else localStorage.removeItem('routeAdminPassword');
    }

    function headers() {
      const h = {};
      const t = getToken();
      if (t) h['X-Admin-Password'] = t;
      return h;
    }

    async function loadJsonData() {
      const res = await fetch('/admin/routes.json', { headers: headers() });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
      let obj = {};
      try { obj = JSON.parse(txt); } catch (_) {}
      return obj;
    }

    async function saveJsonData(obj) {
      const res = await fetch('/admin/routes.json', {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, headers()),
        body: JSON.stringify(obj),
      });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
      return true;
    }

    async function fetchRoutesJson() {
      els.jsonStatus.textContent = '';
      try {
        const obj = await loadJsonData();
        try { els.rulesJson.value = JSON.stringify(obj, null, 2); }
        catch (_) { els.rulesJson.value = ''; }
        els.jsonStatus.textContent = '已加载';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = '加载失败：' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function saveRoutesJson() {
      els.jsonStatus.textContent = '';
      try {
        let obj;
        try { obj = JSON.parse(els.rulesJson.value); } catch (e) { throw new Error('JSON 解析失败：' + e.message); }
        await saveJsonData(obj);
        els.jsonStatus.textContent = '已保存';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function fetchRoutes() {
      els.tokenStatus.textContent = '';
      try {
        const obj = await loadJsonData();
        els.defaultBackend.value = obj.default_backend || '';
      } catch (e) {
        els.tokenStatus.textContent = '无法获取路由：' + e.message;
        els.tokenStatus.className = 'status err';
      }
    }

    async function setDefault() {
      els.defaultStatus.textContent = '';
      try {
        const url = els.defaultBackend.value.trim();
        if (!url) throw new Error('默认后端不能为空');
        const obj = await loadJsonData();
        obj.default_backend = url;
        await saveJsonData(obj);
        els.defaultStatus.textContent = '已更新';
        els.defaultStatus.className = 'status ok';
      } catch (e) {
        els.defaultStatus.textContent = '失败：' + e.message;
        els.defaultStatus.className = 'status err';
      }
    }

    // 可视化编辑：构建/渲染/收集
    function ruleBlockTemplate(r) {
      r = r || {};
      const match = r.match || {};
      const headers = Array.isArray(match.headers) ? match.headers : [];
      const div = document.createElement('div');
      div.className = 'card';
      div.style.margin = '8px 0';
      div.innerHTML = `
        <div class="row" style="gap:8px;">
          <select class="ve-action">
            <option value="proxy" ${r.action === 'redirect' ? '' : 'selected'}>proxy</option>
            <option value="redirect" ${r.action === 'redirect' ? 'selected' : ''}>redirect</option>
          </select>
          <input class="ve-id" type="text" placeholder="id（可选）" value="${r.id || ''}">
          <input class="ve-pri" type="text" placeholder="priority（数字，默认0）" value="${r.priority != null ? r.priority : ''}">
          <input class="ve-backend" type="text" placeholder="backend（action=proxy 必填）" value="${r.backend || ''}">
          <input class="ve-redirect-to" type="text" placeholder="redirect_to（重定向目标）" value="${r.redirect_to || ''}">
          <input class="ve-redirect-prefix" type="text" placeholder="redirect_to_prefix（重定向前缀拼接）" value="${r.redirect_to_prefix || ''}">
          <button class="ve-del danger">删除规则</button>
        </div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <input class="ve-host" type="text" placeholder="match.host" value="${match.host || ''}">
          <input class="ve-path-eq" type="text" placeholder="match.path_equal" value="${match.path_equal || ''}">
          <input class="ve-path-pfx" type="text" placeholder="match.path_prefix" value="${match.path_prefix || ''}">
          <input class="ve-ref-sub" type="text" placeholder="match.referer_substr" value="${match.referer_substr || ''}">
          <input class="ve-ref-reg" type="text" placeholder="match.referer_regex" value="${match.referer_regex || ''}">
          <input class="ve-method" type="text" placeholder="match.method" value="${match.method || ''}">
        </div>
        <div class="muted" style="margin-top:6px;">Headers 条件</div>
        <div class="ve-headers"></div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <button class="ve-add-header secondary">添加 Header 条件</button>
        </div>
      `;
      const headersBox = div.querySelector('.ve-headers');
      function addHeaderRow(h) {
        h = h || {}; const row = document.createElement('div');
        row.className = 'row'; row.style.gap = '8px'; row.style.marginTop = '6px';
        row.innerHTML = `
          <input class="ve-h-name" type="text" placeholder="name" value="${h.name || ''}">
          <input class="ve-h-contains" type="text" placeholder="contains" value="${h.contains || ''}">
          <input class="ve-h-regex" type="text" placeholder="regex" value="${h.regex || ''}">
          <button class="ve-h-del danger">删除</button>
        `;
        row.querySelector('.ve-h-del').onclick = () => row.remove();
        headersBox.appendChild(row);
      }
      headers.forEach(addHeaderRow);
      div.querySelector('.ve-add-header').onclick = () => addHeaderRow({});
      div.querySelector('.ve-del').onclick = () => div.remove();
      return div;
    }

    function renderVisualEditor(obj) {
      els.veDefault.value = obj.default_backend || '';
      els.veRules.innerHTML = '';
      (obj.rules || []).forEach(r => {
        els.veRules.appendChild(ruleBlockTemplate(r));
      });
    }

    function collectVisualJson() {
      const rules = [];
      const blocks = els.veRules.children;
      for (let i=0;i<blocks.length;i++) {
        const b = blocks[i];
        const action = b.querySelector('.ve-action').value || 'proxy';
        const id = b.querySelector('.ve-id').value.trim();
        const pri = parseInt(b.querySelector('.ve-pri').value, 10);
        const backend = b.querySelector('.ve-backend').value.trim();
        const redirect_to = b.querySelector('.ve-redirect-to').value.trim();
        const redirect_to_prefix = b.querySelector('.ve-redirect-prefix').value.trim();
        const match = {
          host: b.querySelector('.ve-host').value.trim() || undefined,
          path_equal: b.querySelector('.ve-path-eq').value.trim() || undefined,
          path_prefix: b.querySelector('.ve-path-pfx').value.trim() || undefined,
          referer_substr: b.querySelector('.ve-ref-sub').value.trim() || undefined,
          referer_regex: b.querySelector('.ve-ref-reg').value.trim() || undefined,
          method: b.querySelector('.ve-method').value.trim() || undefined,
        };
        // headers collect
        const hs = [];
        const headerRows = b.querySelectorAll('.ve-headers .row');
        headerRows.forEach(r => {
          const name = r.querySelector('.ve-h-name').value.trim();
          const contains = r.querySelector('.ve-h-contains').value.trim();
          const regex = r.querySelector('.ve-h-regex').value.trim();
          if (name) hs.push({ name, contains: contains || undefined, regex: regex || undefined });
        });
        if (hs.length) match.headers = hs;

        const rule = { action, id: id || undefined, priority: isNaN(pri)? 0 : pri, match };
        if (action === 'proxy') rule.backend = backend;
        if (action === 'redirect') {
          if (redirect_to) rule.redirect_to = redirect_to;
          if (redirect_to_prefix) rule.redirect_to_prefix = redirect_to_prefix;
        }
        rules.push(rule);
      }
      return { default_backend: els.veDefault.value.trim(), rules };
    }

    async function loadVisual() {
      try {
        const obj = await loadJsonData();
        renderVisualEditor(obj);
        els.jsonStatus.textContent = '可视化已加载';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = '加载失败：' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function saveVisual() {
      try {
        const obj = collectVisualJson();
        await saveJsonData(obj);
        els.jsonStatus.textContent = '已保存';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = '保存失败：' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    function switchMode() {
      const visual = els.visualEditorBox.style.display !== 'none';
      if (visual) {
        els.visualEditorBox.style.display = 'none';
        els.jsonEditorBox.style.display = '';
        els.toggleMode.textContent = '切换到可视化编辑';
      } else {
        els.visualEditorBox.style.display = '';
        els.jsonEditorBox.style.display = 'none';
        els.toggleMode.textContent = '切换到代码编辑';
        loadVisual();
      }
    }

    // 事件绑定
    els.saveToken.onclick = () => {
      setToken(els.token.value.trim());
      els.tokenStatus.textContent = '密码已保存到本地浏览器';
      els.tokenStatus.className = 'status ok';
      fetchRoutes();
      fetchRoutesJson();
    };
    els.setDefault.onclick = setDefault;
    els.loadJson.onclick = fetchRoutesJson;
    els.saveJson.onclick = saveRoutesJson;
    els.veAddRule.onclick = () => els.veRules.appendChild(ruleBlockTemplate({ action: 'proxy', priority: 0 }));
    els.veSave.onclick = saveVisual;
    els.toggleMode.onclick = switchMode;
    els.btnChgPwd.onclick = async () => {
      els.chgPwdStatus.textContent = '';
      try {
        const cur = els.oldPass.value.trim();
        const np = els.newPass.value.trim();
        const np2 = els.newPass2.value.trim();
        if (!cur || !np) throw new Error('请输入当前密码和新密码');
        if (np !== np2) throw new Error('两次输入的新密码不一致');
        const res = await fetch('/admin/password', {
          method: 'POST',
          headers: Object.assign({ 'Content-Type': 'application/json', 'X-Admin-Password': cur }, headers()),
          body: JSON.stringify({ new_password: np })
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
        setToken(np);
        els.token.value = np;
        els.chgPwdStatus.textContent = '已修改';
        els.chgPwdStatus.className = 'status ok';
      } catch (e) {
        els.chgPwdStatus.textContent = e.message;
        els.chgPwdStatus.className = 'status err';
      }
    };

    // 初始化
    (function init() {
      const t = getToken();
      if (t) els.token.value = t;
      fetchRoutes();
      fetchRoutesJson();
    })();
  </script>
</body>
</html>

