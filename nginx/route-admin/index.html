<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nginx åŠ¨æ€è·¯ç”±ç®¡ç†</title>
  <style>
    :root { --bg:#0b1020; --card:#121933; --fg:#e7ecff; --muted:#a7b0d6; --accent:#6aa3ff; --ok:#2ecc71; --err:#ff4757; }
    html,body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Noto Sans SC, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    h2 { font-size: 16px; margin: 16px 0 8px; color: var(--muted); }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    input[type=text], input[type=password] { flex: 1 1 240px; padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3359; background: #0e1430; color: var(--fg); outline: none; }
    input[type=text]:focus, input[type=password]:focus { border-color: var(--accent); }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: var(--accent); color: #fff; cursor: pointer; }
    button.secondary { background: #33406e; }
    button.danger { background: var(--err); }
    .muted { color: var(--muted); font-size: 12px; }
    .status { margin-left: 8px; font-size: 12px; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    textarea { width: 100%; min-height: 260px; padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3359; background: #0e1430; color: var(--fg); outline: none; resize: vertical; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sync Status Card (only shown during sync) -->
    <div class="card" id="syncStatusCard" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <h1 style="text-align:center; margin-bottom:20px;">ğŸ”„ æ­£åœ¨åŒæ­¥æ•°æ®</h1>
      <p style="text-align:center; margin-bottom:20px; opacity:0.9;">è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨æ¢å¤æ‚¨çš„é…ç½®å’Œæ–‡ä»¶...</p>
      
      <div style="width:100%; height:30px; background:rgba(255,255,255,0.2); border-radius:15px; overflow:hidden; margin-bottom:15px; position:relative;">
        <div id="syncProgressBar" style="height:100%; background:linear-gradient(90deg, #4CAF50, #8BC34A); border-radius:15px; transition:width 0.5s ease; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; width:0%;">
          <span id="syncProgressText">0%</span>
        </div>
      </div>
      
      <div style="text-align:center; padding:12px; background:rgba(255,255,255,0.1); border-radius:8px;">
        <div style="display:inline-block; width:16px; height:16px; border:3px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:8px; vertical-align:middle;"></div>
        <span id="syncStatusText">æ­£åœ¨åˆå§‹åŒ–...</span>
      </div>
      
      <div style="text-align:center; margin-top:12px; font-size:13px; opacity:0.7;" id="syncStageInfo">å‡†å¤‡ä¸­...</div>
    </div>
    
    <div class="card">
      <h1>Nginx åŠ¨æ€è·¯ç”±ç®¡ç†</h1>
      <div class="row">
        <input id="token" type="password" placeholder="ç®¡ç†å‘˜å¯†ç ï¼ˆé»˜è®¤ï¼šadminï¼‰" />
        <button id="saveToken">ä¿å­˜å¯†ç </button>
        <span id="tokenStatus" class="status"></span>
      </div>
      <div class="footer">è¯´æ˜ï¼šæœ¬ç•Œé¢é€šè¿‡ <code>/admin/routes.json</code> ä¸ <code>/admin/password</code> æ¥å£ç®¡ç†é…ç½®ï¼Œæ‰€æœ‰è¯·æ±‚å‡éœ€æºå¸¦ç®¡ç†å‘˜å¯†ç ã€‚</div>
    </div>

    <div class="card">
      <h2>é»˜è®¤åç«¯</h2>
      <div class="row">
        <input id="defaultBackend" type="text" placeholder="ä¾‹å¦‚ï¼šhttp://127.0.0.1:6185" />
        <button id="setDefault">æ›´æ–°é»˜è®¤åç«¯</button>
        <span id="defaultStatus" class="status"></span>
      </div>
    </div>

    <div class="card">
      <h2>é«˜çº§è§„åˆ™ï¼ˆJSON é…ç½®ï¼‰</h2>
      <div class="muted">æ”¯æŒæŒ‰ Hostã€Path å‰ç¼€ã€Refererï¼ˆå­ä¸²/æ­£åˆ™ï¼‰ã€HTTP æ–¹æ³•ã€Header æ¡ä»¶è¿›è¡ŒåŒ¹é…ï¼Œå¹¶é€šè¿‡ä¼˜å…ˆçº§æ§åˆ¶å…ˆåé¡ºåºã€‚ä¿å­˜åå³æ—¶ç”Ÿæ•ˆã€‚</div>
      <div class="row" style="margin: 8px 0; gap: 8px;">
        <button id="loadJson" class="secondary">åŠ è½½ JSON</button>
        <button id="toggleMode" class="secondary">åˆ‡æ¢åˆ°å¯è§†åŒ–ç¼–è¾‘</button>
        <span id="jsonStatus" class="status"></span>
      </div>

      <div id="jsonEditorBox">
        <div class="row" style="margin: 8px 0; gap: 8px;">
          <button id="saveJson">ä¿å­˜ JSON</button>
        </div>
        <textarea id="rulesJson" placeholder='ç¤ºä¾‹ï¼š
{
  "default_backend": "http://127.0.0.1:6185",
  "rules": [
    {
      "id": "service-a",
      "action": "proxy",
      "priority": 100,
      "backend": "http://127.0.0.1:7001",
      "match": {"host": "example.com", "path_prefix": "/api/a"}
    },
    {
      "id": "service-b",
      "action": "redirect",
      "priority": 90,
      "match": {"path_prefix": "/legacy/"},
      "redirect_to_prefix": "/new/"
    }
  ]
}
'></textarea>
      </div>

      <div id="visualEditorBox" style="display:none;">
        <div class="row" style="margin: 8px 0; gap: 8px;">
          <input id="veDefault" type="text" placeholder="é»˜è®¤åç«¯ï¼ˆå¦‚ï¼šhttp://127.0.0.1:6185ï¼‰" />
          <button id="veAddRule">æ·»åŠ è§„åˆ™</button>
          <button id="veSave">ä¿å­˜ï¼ˆå¯è§†åŒ–ï¼‰</button>
        </div>
        <div id="veRules"></div>
      </div>
    </div>

    <div class="card">
      <h2>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h2>
      <div class="row" style="gap:8px;">
        <input id="oldPass" type="password" placeholder="å½“å‰å¯†ç " />
        <input id="newPass" type="password" placeholder="æ–°å¯†ç " />
        <input id="newPass2" type="password" placeholder="ç¡®è®¤æ–°å¯†ç " />
        <button id="btnChgPwd">ä¿®æ”¹å¯†ç </button>
        <span id="chgPwdStatus" class="status"></span>
      </div>
    </div>

    <div class="muted">Â© åŠ¨æ€è·¯ç”±é¢æ¿</div>
  </div>

  <script>
    const els = {
      token: document.getElementById('token'),
      saveToken: document.getElementById('saveToken'),
      tokenStatus: document.getElementById('tokenStatus'),
      defaultBackend: document.getElementById('defaultBackend'),
      setDefault: document.getElementById('setDefault'),
      defaultStatus: document.getElementById('defaultStatus'),
      rulesJson: document.getElementById('rulesJson'),
      loadJson: document.getElementById('loadJson'),
      saveJson: document.getElementById('saveJson'),
      jsonStatus: document.getElementById('jsonStatus'),
      toggleMode: document.getElementById('toggleMode'),
      jsonEditorBox: document.getElementById('jsonEditorBox'),
      visualEditorBox: document.getElementById('visualEditorBox'),
      veDefault: document.getElementById('veDefault'),
      veRules: document.getElementById('veRules'),
      veAddRule: document.getElementById('veAddRule'),
      veSave: document.getElementById('veSave'),
      oldPass: document.getElementById('oldPass'),
      newPass: document.getElementById('newPass'),
      newPass2: document.getElementById('newPass2'),
      btnChgPwd: document.getElementById('btnChgPwd'),
      chgPwdStatus: document.getElementById('chgPwdStatus'),
    };

    function getToken() {
      return localStorage.getItem('routeAdminPassword') || '';
    }

    function setToken(t) {
      if (t) localStorage.setItem('routeAdminPassword', t); else localStorage.removeItem('routeAdminPassword');
    }

    function headers() {
      const h = {};
      const t = getToken();
      if (t) h['X-Admin-Password'] = t;
      return h;
    }

    async function loadJsonData() {
      const res = await fetch('/admin/routes.json', { headers: headers() });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
      let obj = {};
      try { obj = JSON.parse(txt); } catch (_) {}
      return obj;
    }

    async function saveJsonData(obj) {
      const res = await fetch('/admin/routes.json', {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, headers()),
        body: JSON.stringify(obj),
      });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
      return true;
    }

    async function fetchRoutesJson() {
      els.jsonStatus.textContent = '';
      try {
        const obj = await loadJsonData();
        try { els.rulesJson.value = JSON.stringify(obj, null, 2); }
        catch (_) { els.rulesJson.value = ''; }
        els.jsonStatus.textContent = 'å·²åŠ è½½';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = 'åŠ è½½å¤±è´¥ï¼š' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function saveRoutesJson() {
      els.jsonStatus.textContent = '';
      try {
        let obj;
        try { obj = JSON.parse(els.rulesJson.value); } catch (e) { throw new Error('JSON è§£æå¤±è´¥ï¼š' + e.message); }
        await saveJsonData(obj);
        els.jsonStatus.textContent = 'å·²ä¿å­˜';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function fetchRoutes() {
      els.tokenStatus.textContent = '';
      try {
        const obj = await loadJsonData();
        els.defaultBackend.value = obj.default_backend || '';
      } catch (e) {
        els.tokenStatus.textContent = 'æ— æ³•è·å–è·¯ç”±ï¼š' + e.message;
        els.tokenStatus.className = 'status err';
      }
    }

    async function setDefault() {
      els.defaultStatus.textContent = '';
      try {
        const url = els.defaultBackend.value.trim();
        if (!url) throw new Error('é»˜è®¤åç«¯ä¸èƒ½ä¸ºç©º');
        const obj = await loadJsonData();
        obj.default_backend = url;
        await saveJsonData(obj);
        els.defaultStatus.textContent = 'å·²æ›´æ–°';
        els.defaultStatus.className = 'status ok';
      } catch (e) {
        els.defaultStatus.textContent = 'å¤±è´¥ï¼š' + e.message;
        els.defaultStatus.className = 'status err';
      }
    }

    // å¯è§†åŒ–ç¼–è¾‘ï¼šæ„å»º/æ¸²æŸ“/æ”¶é›†
    function ruleBlockTemplate(r) {
      r = r || {};
      const match = r.match || {};
      const headers = Array.isArray(match.headers) ? match.headers : [];
      const div = document.createElement('div');
      div.className = 'card';
      div.style.margin = '8px 0';
      div.innerHTML = `
        <div class="row" style="gap:8px;">
          <select class="ve-action">
            <option value="proxy" ${r.action === 'redirect' ? '' : 'selected'}>proxy</option>
            <option value="redirect" ${r.action === 'redirect' ? 'selected' : ''}>redirect</option>
          </select>
          <input class="ve-id" type="text" placeholder="idï¼ˆå¯é€‰ï¼‰" value="${r.id || ''}">
          <input class="ve-pri" type="text" placeholder="priorityï¼ˆæ•°å­—ï¼Œé»˜è®¤0ï¼‰" value="${r.priority != null ? r.priority : ''}">
          <input class="ve-backend" type="text" placeholder="backendï¼ˆaction=proxy å¿…å¡«ï¼‰" value="${r.backend || ''}">
          <input class="ve-redirect-to" type="text" placeholder="redirect_toï¼ˆé‡å®šå‘ç›®æ ‡ï¼‰" value="${r.redirect_to || ''}">
          <input class="ve-redirect-prefix" type="text" placeholder="redirect_to_prefixï¼ˆé‡å®šå‘å‰ç¼€æ‹¼æ¥ï¼‰" value="${r.redirect_to_prefix || ''}">
          <button class="ve-del danger">åˆ é™¤è§„åˆ™</button>
        </div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <input class="ve-host" type="text" placeholder="match.host" value="${match.host || ''}">
          <input class="ve-path-eq" type="text" placeholder="match.path_equal" value="${match.path_equal || ''}">
          <input class="ve-path-pfx" type="text" placeholder="match.path_prefix" value="${match.path_prefix || ''}">
          <input class="ve-ref-sub" type="text" placeholder="match.referer_substr" value="${match.referer_substr || ''}">
          <input class="ve-ref-reg" type="text" placeholder="match.referer_regex" value="${match.referer_regex || ''}">
          <input class="ve-method" type="text" placeholder="match.method" value="${match.method || ''}">
        </div>
        <div class="muted" style="margin-top:6px;">Headers æ¡ä»¶</div>
        <div class="ve-headers"></div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <button class="ve-add-header secondary">æ·»åŠ  Header æ¡ä»¶</button>
        </div>
      `;
      const headersBox = div.querySelector('.ve-headers');
      function addHeaderRow(h) {
        h = h || {}; const row = document.createElement('div');
        row.className = 'row'; row.style.gap = '8px'; row.style.marginTop = '6px';
        row.innerHTML = `
          <input class="ve-h-name" type="text" placeholder="name" value="${h.name || ''}">
          <input class="ve-h-contains" type="text" placeholder="contains" value="${h.contains || ''}">
          <input class="ve-h-regex" type="text" placeholder="regex" value="${h.regex || ''}">
          <button class="ve-h-del danger">åˆ é™¤</button>
        `;
        row.querySelector('.ve-h-del').onclick = () => row.remove();
        headersBox.appendChild(row);
      }
      headers.forEach(addHeaderRow);
      div.querySelector('.ve-add-header').onclick = () => addHeaderRow({});
      div.querySelector('.ve-del').onclick = () => div.remove();
      return div;
    }

    function renderVisualEditor(obj) {
      els.veDefault.value = obj.default_backend || '';
      els.veRules.innerHTML = '';
      (obj.rules || []).forEach(r => {
        els.veRules.appendChild(ruleBlockTemplate(r));
      });
    }

    function collectVisualJson() {
      const rules = [];
      const blocks = els.veRules.children;
      for (let i=0;i<blocks.length;i++) {
        const b = blocks[i];
        const action = b.querySelector('.ve-action').value || 'proxy';
        const id = b.querySelector('.ve-id').value.trim();
        const pri = parseInt(b.querySelector('.ve-pri').value, 10);
        const backend = b.querySelector('.ve-backend').value.trim();
        const redirect_to = b.querySelector('.ve-redirect-to').value.trim();
        const redirect_to_prefix = b.querySelector('.ve-redirect-prefix').value.trim();
        const match = {
          host: b.querySelector('.ve-host').value.trim() || undefined,
          path_equal: b.querySelector('.ve-path-eq').value.trim() || undefined,
          path_prefix: b.querySelector('.ve-path-pfx').value.trim() || undefined,
          referer_substr: b.querySelector('.ve-ref-sub').value.trim() || undefined,
          referer_regex: b.querySelector('.ve-ref-reg').value.trim() || undefined,
          method: b.querySelector('.ve-method').value.trim() || undefined,
        };
        // headers collect
        const hs = [];
        const headerRows = b.querySelectorAll('.ve-headers .row');
        headerRows.forEach(r => {
          const name = r.querySelector('.ve-h-name').value.trim();
          const contains = r.querySelector('.ve-h-contains').value.trim();
          const regex = r.querySelector('.ve-h-regex').value.trim();
          if (name) hs.push({ name, contains: contains || undefined, regex: regex || undefined });
        });
        if (hs.length) match.headers = hs;

        const rule = { action, id: id || undefined, priority: isNaN(pri)? 0 : pri, match };
        if (action === 'proxy') rule.backend = backend;
        if (action === 'redirect') {
          if (redirect_to) rule.redirect_to = redirect_to;
          if (redirect_to_prefix) rule.redirect_to_prefix = redirect_to_prefix;
        }
        rules.push(rule);
      }
      return { default_backend: els.veDefault.value.trim(), rules };
    }

    async function loadVisual() {
      try {
        const obj = await loadJsonData();
        renderVisualEditor(obj);
        els.jsonStatus.textContent = 'å¯è§†åŒ–å·²åŠ è½½';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = 'åŠ è½½å¤±è´¥ï¼š' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    async function saveVisual() {
      try {
        const obj = collectVisualJson();
        await saveJsonData(obj);
        els.jsonStatus.textContent = 'å·²ä¿å­˜';
        els.jsonStatus.className = 'status ok';
      } catch (e) {
        els.jsonStatus.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + e.message;
        els.jsonStatus.className = 'status err';
      }
    }

    function switchMode() {
      const visual = els.visualEditorBox.style.display !== 'none';
      if (visual) {
        els.visualEditorBox.style.display = 'none';
        els.jsonEditorBox.style.display = '';
        els.toggleMode.textContent = 'åˆ‡æ¢åˆ°å¯è§†åŒ–ç¼–è¾‘';
      } else {
        els.visualEditorBox.style.display = '';
        els.jsonEditorBox.style.display = 'none';
        els.toggleMode.textContent = 'åˆ‡æ¢åˆ°ä»£ç ç¼–è¾‘';
        loadVisual();
      }
    }

    // äº‹ä»¶ç»‘å®š
    els.saveToken.onclick = () => {
      setToken(els.token.value.trim());
      els.tokenStatus.textContent = 'å¯†ç å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨';
      els.tokenStatus.className = 'status ok';
      fetchRoutes();
      fetchRoutesJson();
    };
    els.setDefault.onclick = setDefault;
    els.loadJson.onclick = fetchRoutesJson;
    els.saveJson.onclick = saveRoutesJson;
    els.veAddRule.onclick = () => els.veRules.appendChild(ruleBlockTemplate({ action: 'proxy', priority: 0 }));
    els.veSave.onclick = saveVisual;
    els.toggleMode.onclick = switchMode;
    els.btnChgPwd.onclick = async () => {
      els.chgPwdStatus.textContent = '';
      try {
        const cur = els.oldPass.value.trim();
        const np = els.newPass.value.trim();
        const np2 = els.newPass2.value.trim();
        if (!cur || !np) throw new Error('è¯·è¾“å…¥å½“å‰å¯†ç å’Œæ–°å¯†ç ');
        if (np !== np2) throw new Error('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
        const res = await fetch('/admin/password', {
          method: 'POST',
          headers: Object.assign({ 'Content-Type': 'application/json', 'X-Admin-Password': cur }, headers()),
          body: JSON.stringify({ new_password: np })
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
        setToken(np);
        els.token.value = np;
        els.chgPwdStatus.textContent = 'å·²ä¿®æ”¹';
        els.chgPwdStatus.className = 'status ok';
      } catch (e) {
        els.chgPwdStatus.textContent = e.message;
        els.chgPwdStatus.className = 'status err';
      }
    };

    // åŒæ­¥çŠ¶æ€æ£€æŸ¥
    const syncStatusMessages = {
      'starting': 'æ­£åœ¨å¯åŠ¨åŒæ­¥è¿›ç¨‹...',
      'git': 'æ­£åœ¨åŒæ­¥ Git ä»“åº“...',
      'linking': 'æ­£åœ¨åˆ›å»ºç¬¦å·é“¾æ¥...',
      'lfs_download': 'æ­£åœ¨ä¸‹è½½å¤§æ–‡ä»¶...',
      'complete': 'åŒæ­¥å®Œæˆï¼'
    };

    async function checkSyncStatus() {
      try {
        const res = await fetch('/api/sync-progress');
        const data = await res.json();
        
        const progress = data.progress || 0;
        const stage = data.stage || 'starting';
        const current = data.current || 0;
        const total = data.total || 0;
        
        // æ›´æ–°è¿›åº¦æ¡
        document.getElementById('syncProgressBar').style.width = progress + '%';
        document.getElementById('syncProgressText').innerText = progress + '%';
        
        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        const statusText = syncStatusMessages[stage] || 'æ­£åœ¨å¤„ç†...';
        document.getElementById('syncStatusText').innerText = statusText;
        
        // æ›´æ–°è¯¦ç»†ä¿¡æ¯
        let stageInfo = '';
        if (stage === 'lfs_download' && total > 0) {
          stageInfo = `æ­£åœ¨ä¸‹è½½: ${current}/${total} ä¸ªæ–‡ä»¶`;
        } else if (stage === 'git') {
          stageInfo = 'æ‹‰å–é…ç½®å’ŒæŒ‡é’ˆæ–‡ä»¶...';
        } else if (stage === 'linking') {
          stageInfo = 'å‡†å¤‡æ•°æ®ç›®å½•...';
        } else if (stage === 'complete') {
          stageInfo = 'å‡†å¤‡å°±ç»ªï¼';
        }
        document.getElementById('syncStageInfo').innerText = stageInfo;
        
        // å¦‚æœè¿›åº¦ < 100ï¼Œæ˜¾ç¤ºåŒæ­¥å¡ç‰‡å¹¶ç»§ç»­è½®è¯¢
        if (progress < 100) {
          document.getElementById('syncStatusCard').style.display = '';
          setTimeout(checkSyncStatus, 2000);
        } else {
          // åŒæ­¥å®Œæˆï¼Œéšè—å¡ç‰‡
          document.getElementById('syncStatusCard').style.display = 'none';
        }
      } catch (error) {
        // å¦‚æœæ— æ³•è·å–è¿›åº¦ï¼ˆå¯èƒ½æ˜¯åŒæ­¥å·²å®Œæˆæˆ–APIä¸å¯ç”¨ï¼‰ï¼Œéšè—å¡ç‰‡
        document.getElementById('syncStatusCard').style.display = 'none';
      }
    }

    // åˆå§‹åŒ–
    (function init() {
      const t = getToken();
      if (t) els.token.value = t;
      
      // å…ˆæ£€æŸ¥åŒæ­¥çŠ¶æ€
      checkSyncStatus();
      
      fetchRoutes();
      fetchRoutesJson();
    })();
  </script>
</body>
</html>

